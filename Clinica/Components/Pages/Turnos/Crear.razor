@page "/turnos/crear"
@rendermode InteractiveServer
@using TurnosClinica.ApiClients.Consultorios
@using TurnosClinica.ApiClients.Estados
@using TurnosClinica.ApiClients.Turnos
@using TurnosClinica.ApiClients.Medicos
@using TurnosClinica.ApiClients.Pacientes
@using TurnosClinica.Application.DTOs.Turnos
@inject TurnosApiClient Api
@inject MedicosApiClient MedicosApi
@inject ConsultoriosApiClient ConsultoriosApi
@inject EstadosApiClient EstadosApi
@inject PacientesApiClient PacientesApi
@inject NavigationManager Nav

<h3>Crear turno</h3>

@if (!string.IsNullOrWhiteSpace(Error))
{
    <div class="alert alert-danger">@Error</div>
}

<div class="mb-3">
    <label class="form-label">Paciente (buscar por DNI)</label>

    <div class="input-group">
        <input class="form-control" placeholder="DNI"
               @bind="DniBusqueda" />
        <button class="btn btn-outline-primary" @onclick="BuscarPaciente" disabled="@BuscandoPaciente">
            @(BuscandoPaciente ? "Buscando..." : "Buscar")
        </button>
    </div>

    @if (!string.IsNullOrWhiteSpace(ErrorPacientes))
    {
        <div class="text-danger mt-1">@ErrorPacientes</div>
    }

    @if (PacienteAsignado is not null)
    {
        <div class="alert alert-success mt-2 mb-0 d-flex justify-content-between align-items-center">
            <div>
                <strong>Paciente asignado:</strong>
                @PacienteAsignado.Apellido, @PacienteAsignado.Nombre (DNI: @PacienteAsignado.DNI)
            </div>
            <button class="btn btn-sm btn-outline-danger" @onclick="QuitarPaciente">
                Quitar
            </button>
        </div>
    }

    @if (ResultadoBusqueda is not null)
    {
        <div class="card mt-2">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <strong>@ResultadoBusqueda.Apellido, @ResultadoBusqueda.Nombre</strong>
                    <div class="small text-muted">DNI: @ResultadoBusqueda.DNI</div>
                </div>
                <button class="btn btn-sm btn-success" @onclick="AsignarPaciente">
                    Asignar
                </button>
            </div>
        </div>
    }
    else if (Buscado && !BuscandoPaciente && PacienteAsignado is null)
    {
        <div class="form-text mt-2">No se encontró paciente con ese DNI.</div>
        <!-- opcional: botón crear paciente -->
    }
</div>


<div class="mb-3">
    <label class="form-label">Medicos</label>
    @if (CargandoMedicos)
    {
        <div class="form-text">Cargando medicos...</div>
    }
    else
    {
        <select class="form-select" @bind="Model.MedicoId">
            <option value="0" disabled>-- Seleccioná un medico --</option>

            @foreach (var m in Medicos)
            {
                <option value="@m.Id">@m.Nombre</option>
            }
        </select>

        @if (!string.IsNullOrWhiteSpace(ErrorMedicos))
        {
            <div class="text-danger mt-1">@ErrorMedicos</div>
        }
    }
</div>

<div class="mb-3">
    <label class="form-label">Consultorios</label>
    @if (CargandoConsultorios)
    {
        <div class="form-text">Cargando consultorios...</div>
    }
    else
    {
        <select class="form-select" @bind="Model.ConsultorioId">
            <option value="0" disabled>-- Seleccioná un consultorio --</option>

            @foreach (var c in Consultorios)
            {
                <option value="@c.Id">@c.Institucion</option>
            }
        </select>

        @if (!string.IsNullOrWhiteSpace(ErrorConsultorios))
        {
            <div class="text-danger mt-1">@ErrorConsultorios</div>
        }
    }
</div>

<div class="mb-3">
    <label class="form-label">Estados</label>
    @if (CargandoEstados)
    {
        <div class="form-text">Cargando estados...</div>
    }
    else
    {
        <select class="form-select" @bind="Model.EstadoId" disabled>
            @foreach (var e in Estados)
            {
                <option value="@e.Id">@e.Nombre</option>
            }
        </select>


        @if (!string.IsNullOrWhiteSpace(ErrorEstados))
        {
            <div class="text-danger mt-1">@ErrorEstados</div>
        }
    }
</div>

<div class="mb-3">
    <label class="form-label">Fecha y hora</label>
    <input class="form-control" type="datetime-local" @bind="Model.FechaLocal" />
</div>

<button class="btn btn-success" @onclick="Create" disabled="@Guardando">
    @(Guardando ? "Guardando..." : "Crear")
</button>

@code {
    private string? Error;
    private bool Guardando;
    private string? Nombre;



    private bool CargandoMedicos;
    private string? ErrorMedicos;

    private bool CargandoConsultorios;
    private string? ErrorConsultorios;

    private bool CargandoEstados;
    private int EstadoSeleccionadoId;
    private string? ErrorEstados;

    private string DniBusqueda = "";
    private bool BuscandoPaciente;
    private bool Buscado;
    private string? ErrorPacientes;

    private PacienteSelectorResponse? ResultadoBusqueda;
    private PacienteSelectorResponse? PacienteAsignado;



    private CrearTurnoVm Model = new() { ConsultorioId = 0, EstadoId = 0, MedicoId = 0 };
    private List<ItemMedicos> Medicos = new();
    private List<ItemConsultorios> Consultorios = new();
    private List<ItemEstados> Estados = new();


    protected override async Task OnInitializedAsync()
    {
        await Task.WhenAll(CargarMedicos(), CargarConsultorios(), CargarEstados());
    }

    private async Task CargarMedicos()
    {
        CargandoMedicos = true;
        ErrorMedicos = null;

        try
        {
            var lista = await MedicosApi.ListarAsync(Nombre);

            Medicos = lista
                .Select(x => new ItemMedicos(x.Id, x.Nombre))
                .OrderBy(x => x.Nombre)
                .ToList();
        }
        catch (Exception ex)
        {
            ErrorMedicos = ex.Message;
            Medicos = new();
        }
        finally
        {
            CargandoMedicos = false;
        }
    }
    private async Task CargarConsultorios()
    {
        CargandoConsultorios = true;
        ErrorConsultorios = null;
        try
        {
            var lista = await ConsultoriosApi.ListarAsync(Nombre);

            Consultorios = lista
                .Select(x => new ItemConsultorios(x.Id, x.Institucion))
                .OrderBy(x => x.Institucion)
                .ToList();
        }
        catch (Exception ex)
        {
            ErrorConsultorios = ex.Message;
            Consultorios = new();
        }
        finally
        {
            CargandoConsultorios = false;
        }
    }

    private async Task CargarEstados()
    {
        CargandoEstados = true;
        ErrorEstados = null;

        try
        {
            var lista = await EstadosApi.ListarAsync(Nombre);

            var pendiente = lista.FirstOrDefault(x => x.Nombre.Equals("Pendiente", StringComparison.OrdinalIgnoreCase));

            if (pendiente is not null)
            {
                // lo pongo primero y lo marco como seleccionado
                Estados.Add(new ItemEstados(pendiente.Id, pendiente.Nombre));
                Model.EstadoId = pendiente.Id;
            }


            Estados = new List<ItemEstados>
            {
            new ItemEstados(pendiente.Id, pendiente.Nombre)
            };

            EstadoSeleccionadoId = pendiente.Id;
        }
        catch (Exception ex)
        {
            ErrorEstados = ex.Message;
            Estados = new();
        }
        finally
        {
            CargandoEstados = false;
        }
    }

    private async Task BuscarPaciente()
    {
        ErrorPacientes = null;
        Buscado = false;
        ResultadoBusqueda = null;

        var dni = (DniBusqueda ?? "").Trim();
        if (string.IsNullOrWhiteSpace(dni))
        {
            ErrorPacientes = "Ingresá un DNI.";
            return;
        }

        BuscandoPaciente = true;
        try
        {
            var p = await PacientesApi.GetIdByDniAsync(dni);

            Buscado = true;
            ResultadoBusqueda = new PacienteSelectorResponse(
                p.Id,
                p.DNI,       // o p.DNI según tu DTO
                p.Nombre,
                p.Apellido
            );
        }
        catch (Exception ex)
        {
            // si tu API devuelve 404 cuando no existe, acá podés mapearlo a "no encontrado"
            ErrorPacientes = ex.Message;
            Buscado = true;
            ResultadoBusqueda = null;
        }
        finally
        {
            BuscandoPaciente = false;
        }
    }


    private void AsignarPaciente()
    {
        if (ResultadoBusqueda is null) return;

        PacienteAsignado = ResultadoBusqueda;
        Model.PacienteId = ResultadoBusqueda.Id; // Guid? recomendado

        ResultadoBusqueda = null;
    }

    private void QuitarPaciente()
    {
        PacienteAsignado = null;
        Model.PacienteId = null;
    }

    private async Task Create()
    {
        Error = null;
        Guardando = true;

        try
        {

            if (Model.MedicoId == 0) { Error = "Seleccioná un médico."; return; }
            if (Model.ConsultorioId == 0) { Error = "Seleccioná un consultorio."; return; }
            if (Model.EstadoId == 0) { Error = "Seleccioná un estado."; return; }


            var req = new CrearTurnoRequest
            {
                PacienteId = Model.PacienteId.Value,
                MedicoId = Model.MedicoId,
                ConsultorioId = Model.ConsultorioId,
                EstadoId = Model.EstadoId,
                FechaTurno = Model.FechaLocal
            };

            await Api.CrearAsync(req);

            Nav.NavigateTo("/turnos");
        }
        catch (TurnosApiException ex)
        {
            Error = ex.Message;
        }
        finally
        {
            Guardando = false;
        }
    }



    private class CrearTurnoVm
    {
        public Guid? PacienteId { get; set; }
        public int MedicoId { get; set; }
        public int ConsultorioId { get; set; }
        public int EstadoId { get; set; }
        public DateTime FechaLocal { get; set; } = DateTime.Now;
    }

    private record ItemMedicos(int Id, string Nombre);

    private record ItemConsultorios(int Id, string Institucion);

    private record ItemEstados(int Id, string Nombre);

    private record PacienteSelectorResponse(Guid Id, string DNI, string Nombre, string Apellido);



}
